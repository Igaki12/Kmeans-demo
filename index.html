<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>K-means 可視化シミュレーター</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
  #controls { padding: 12px; background: #fafafa; box-shadow: 0 0 4px #ccc; }
  #controls label { margin: 0 8px; }
  #chart { border: 1px solid #ccc; cursor: pointer; }
  .node { fill: #999; stroke: #fff; stroke-width: 1px; }
  .centroid { fill: none; stroke: #000; stroke-width: 2px; pointer-events: none; }
</style>
</head>
<body>

<div id="controls">
  <label>N (ノード数):
    <input type="number" id="nInput" value="100" min="10" max="1000" />
  </label>
  <label>K (クラスター数):
    <input type="number" id="kInput" value="5" min="1" max="10" />
  </label>
  <button id="btnStep">ステップ</button>
  <button id="btnReset">最初から</button>
  <button id="btnNew">新規作成</button>
  <span id="iterLabel"></span>
</div>

<svg id="chart" width="600" height="600"></svg>

<script>
(() => {
  const w = 600, h = 600, r = 5;
  const svg = d3.select("#chart");
  const color = d3.schemeTableau10;

  let nodes = [], centroids = [], initCentroids = [], iter = 0;

  // ユーティリティ
  const rand = (min, max) => Math.random() * (max - min) + min;
  const dist2 = (a, b) => (a.x - b.x) ** 2 + (a.y - b.y) ** 2;

  function init(newData = true) {
    iter = 0;
    d3.select("#iterLabel").text("");
    const N = +document.getElementById("nInput").value;
    const K = +document.getElementById("kInput").value;

    if (newData) {
      nodes = d3.range(N).map(() => ({ x: rand(r, w - r), y: rand(r, h - r), cluster: -1 }));
    }

    centroids = d3.range(K).map(() => ({ x: rand(r, w - r), y: rand(r, h - r) }));
    initCentroids = centroids.map(c => ({ x: c.x, y: c.y })); // 深いコピー

    draw();
  }

  function assign() {
    nodes.forEach(n => {
      let min = Infinity, idx = -1;
      centroids.forEach((c, i) => {
        const d = dist2(n, c);
        if (d < min) { min = d; idx = i; }
      });
      n.cluster = idx;
    });
  }

  function update() {
    const K = centroids.length;
    const sums = Array.from({ length: K }, () => ({ x: 0, y: 0, cnt: 0 }));
    nodes.forEach(n => {
      const s = sums[n.cluster];
      s.x += n.x; s.y += n.y; s.cnt++;
    });
    centroids.forEach((c, i) => {
      if (sums[i].cnt) {
        c.x = sums[i].x / sums[i].cnt;
        c.y = sums[i].y / sums[i].cnt;
      }
    });
  }

  function step() {
    assign();
    update();
    iter++;
    d3.select("#iterLabel").text(`Iteration: ${iter}`);
    draw();
  }

  function draw() {
    // ノード
    const circles = svg.selectAll("circle").data(nodes);
    circles.join("circle")
      .attr("class", "node")
      .attr("r", r)
      .attr("cx", d => d.x)
      .attr("cy", d => d.y)
      .attr("fill", d => d.cluster === -1 ? "#999" : color[d.cluster % color.length]);

    // セントロイド
    const xs = svg.selectAll("path.centroid").data(centroids);
    xs.join("path")
      .attr("class", "centroid")
      .attr("stroke", (d, i) => color[i % color.length])
      .attr("d", d3.symbol().type(d3.symbolCross).size(200))
      .attr("transform", d => `translate(${d.x},${d.y})`);
  }

  // イベント
  document.getElementById("btnStep").onclick = step;
  document.getElementById("btnReset").onclick = () => {
    centroids = initCentroids.map(c => ({ ...c }));
    nodes.forEach(n => n.cluster = -1);
    iter = 0;
    d3.select("#iterLabel").text("");
    draw();
  };
  document.getElementById("btnNew").onclick = () => init(true);
  svg.on("click", step);

  // 初期化
  init(true);
})();
</script>
</body>
</html>